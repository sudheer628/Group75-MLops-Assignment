name: Deploy to GCP VM

on:
  # Trigger after container build completes successfully
  workflow_run:
    workflows: ["Build and Push Container"]
    types: [completed]
    branches: [main]
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if container build succeeded OR manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Deploy to GCP VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          script_stop: true
          script: |
            echo "=========================================="
            echo "Starting deployment at $(date)"
            echo "=========================================="
            
            # Navigate to project directory
            cd /home/sudheermyworld/Group75-MLops-Assignment
            
            # Pull latest code changes
            echo "Pulling latest code from GitHub..."
            git pull origin main
            
            # Pull latest container images
            echo "Pulling latest Docker images..."
            docker-compose pull
            
            # Restart containers with new images
            echo "Restarting containers..."
            docker-compose up -d
            
            # Wait for containers to start and model to load
            echo "Waiting for containers to initialize and model to load from Railway..."
            echo "This may take up to 2 minutes..."
            
            # Health check with retries
            echo "Running health check..."
            for i in 1 2 3 4 5 6 7 8 9 10 11 12; do
                if curl -sf http://localhost:8000/health > /dev/null; then
                    echo "Health check PASSED on attempt $i"
                    echo "=========================================="
                    echo "Deployment completed successfully!"
                    echo "API is live at: http://myprojectdemo.online"
                    echo "=========================================="
                    exit 0
                fi
                echo "Attempt $i: API not ready yet, waiting 10 seconds..."
                sleep 10
            done
            
            echo "Health check FAILED after 12 attempts (2 minutes)"
            echo "Checking container logs..."
            docker-compose logs --tail=100
            exit 1

      - name: Deployment Summary
        if: success()
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: GCP VM" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://myprojectdemo.online" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed
        if: failure()
        run: |
          echo "## Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
